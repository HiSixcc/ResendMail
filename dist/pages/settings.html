<!DOCTYPE html>
<html lang="zh-CN" style="height: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ResendMail 智能群发邮件系统 - 设置</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        :root {
            /* 导入全局变量 */
            --primary-color: #3A7DFF;
            --primary-hover-color: #2563EB;
            --primary-text-color: #1A202C;
            --secondary-text-color: #4A5568;
            --page-background-color: #FFFFFF;
            --light-background-color: #F7FAFC;
            --border-color: #E2E8F0;
            --success-color: #10B981;
            --error-color: #EF4444;
            --warning-color: #F59E0B;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        
        body {
            box-sizing: border-box;
            overflow: auto;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--page-background-color);
            color: var(--primary-text-color);
        }
        
        .form-container {
            padding: 30px 40px;
            max-width: 1200px;
            width: 100%;
            box-sizing: border-box;
            margin: 0 auto;
        }
        
        .form-container h2 {
            margin-bottom: 30px;
        }
        
        .settings-section {
            background-color: var(--light-background-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .settings-section p {
            margin-bottom: 15px;
            color: var(--secondary-text-color);
            line-height: 1.5;
        }
        
        .account-item {
            background-color: white;
            margin-bottom: 15px !important;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
            position: relative;
            transition: all 0.2s ease;
        }

        .account-item.active {
            background-color: rgba(58, 125, 255, 0.05);
            border-color: var(--primary-color);
        }

        .account-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-text-color);
            margin-bottom: 12px;
        }

        .account-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .account-detail-item {
            flex: 1;
            min-width: 150px;
        }

        .account-detail-label {
            font-size: 13px;
            color: var(--secondary-text-color);
            margin-bottom: 4px;
        }

        .account-detail-value {
            font-size: 14px;
            word-break: break-all;
        }

        .account-detail-value.monospace {
            font-family: monospace;
        }

        .account-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .account-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .active-label {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 12px;
            border-radius: 30px;
            font-weight: 500;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--light-background-color);
            color: var(--primary-text-color);
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        .btn-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .btn-danger:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }
        
        .empty-accounts-message {
            padding: 25px;
            text-align: center;
            color: var(--secondary-text-color);
            background-color: var(--light-background-color);
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
            border: 1px dashed #cbd5e0;
        }
        
        .empty-state-icon {
            display: block;
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            color: #9CA3AF;
        }
        
        .empty-state-text {
            margin-bottom: 10px;
            font-size: 15px;
        }
        
        .add-account-btn {
            display: inline-block;
            padding: 14px 32px; 
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            width: auto;
        }
        
        .add-account-btn:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(58, 125, 255, 0.4);
        }
        
        .form-group {
            margin-bottom: 20px;
            width: 100%;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added for focus transition */
        }
        
        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(58, 125, 255, 0.2);
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-text-color);
        }
        
        .form-group small.form-text {
            display: block;
            margin-top: 5px;
            color: var(--secondary-text-color);
            font-size: 0.8rem;
        }
        
        .submit-button {
            margin-top: 10px;
            padding: 14px 32px; /* Align with primary CTA */
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px; /* Align with primary CTA */
            font-size: 1rem; /* Align with primary CTA */
            font-weight: 600; /* Align with primary CTA */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Align with primary CTA */
        }
        
        .submit-button:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-2px); /* Align with primary CTA */
            box-shadow: 0 6px 20px rgba(58, 125, 255, 0.4); /* Align with primary CTA */
        }
        
        @media (max-width: 768px) {
            .form-container {
                padding: 20px;
            }
            
            .settings-section {
                padding: 15px;
            }
            
            .account-item {
                padding: 15px;
            }
            
            .form-group input {
                font-size: 15px;
                padding: 8px;
            }
            
            .submit-button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .form-container {
                padding: 15px;
            }
            
            .form-container h2 {
                font-size: 1.5rem;
                margin-bottom: 20px;
            }
            
            .settings-section {
                padding: 15px;
                border-radius: 10px;
            }
            
            .settings-section h3 {
                font-size: 18px;
                margin-bottom: 12px;
                font-weight: 600;
                color: #2563EB;
            }
            
            .account-item {
                padding: 12px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
                border: 1px solid #e5e7eb;
                padding: 15px;
                border-radius: 8px;
                background-color: #f9fafb;
            }
            
            .setting-info {
                margin-bottom: 12px;
                width: 100%;
            }
            
            .toggle-control {
                margin-top: 5px;
                align-self: flex-start;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .toggle-control:before {
                content: "启用";
                font-size: 14px;
                font-weight: 500;
                color: #4B5563;
            }
            
            .setting-row label {
                font-weight: 600;
                color: #111827;
                font-size: 16px;
            }
            
            .setting-row small {
                margin-top: 6px;
                display: block;
                color: #6B7280;
                line-height: 1.4;
            }
            
            .toggle-switch {
                width: 60px;
                height: 30px;
            }
            
            .toggle-slider {
                border-radius: 30px;
            }
            
            .toggle-slider:before {
                height: 22px;
                width: 22px;
                left: 4px;
                bottom: 4px;
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(30px);
            }
            
            .toggle-status {
                font-size: 13px;
                min-width: 40px;
            }
            
            .feature-list {
                margin-left: 0;
                padding-left: 20px;
                margin-bottom: 15px;
            }
            
            .feature-list li {
                margin-bottom: 10px;
                position: relative;
                line-height: 1.5;
                font-size: 14px;
            }
            
            .feature-list li:before {
                content: "";
                position: absolute;
                left: -20px;
                top: 6px;
                width: 8px;
                height: 8px;
                background-color: #3A7DFF;
                border-radius: 50%;
            }
            
            .feature-highlight {
                margin-top: 15px;
                padding: 12px;
                background-color: rgba(16, 185, 129, 0.1);
                border-left: 3px solid #10B981;
                border-radius: 4px;
                color: #065F46;
                font-weight: 500;
                font-size: 14px;
            }
            
            .empty-accounts-message {
                padding: 20px;
            }
            
            .empty-state-icon {
                width: 50px;
                height: 50px;
                margin-bottom: 10px;
            }
        }

        /* 设置项行布局 */
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }

        .setting-info {
            flex: 1;
        }

        .setting-info label {
            display: block;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .toggle-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 现代化开关样式 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* 添加滑动开关的焦点样式 */
        input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary-color), inset 0 1px 3px rgba(0,0,0,0.2);
        }

        /* 开关状态文本样式 */
        .toggle-status {
            font-size: 12px;
            font-weight: 500;
            min-width: 36px;
            text-align: left;
        }

        .toggle-status:after {
            content: "关闭";
            color: #999;
        }

        input:checked ~ .toggle-status:after {
            content: "开启";
            color: var(--primary-color);
        }
        
        /* 系统说明基础样式 */
        .feature-list {
            margin-left: 20px; 
            margin-bottom: 15px;
            padding-left: 0;
        }
        
        .feature-highlight {
            margin-top: 10px; 
            color: var(--success-color);
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--page-background-color);
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
        }

        .modal-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-text-color);
            font-size: 20px;
            font-weight: 600;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn-cancel {
            border: 1px solid var(--border-color);
            background-color: white;
            color: var(--secondary-text-color);
        }
        
        .modal-btn-cancel:hover {
            background-color: #f5f5f5;
        }
        
        .modal-btn-save {
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .modal-btn-save:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 15% auto;
                padding: 20px;
                width: 95%;
                max-width: none;
            }

            .form-group input {
                padding: 12px;
            }

            .modal-footer {
                margin-top: 20px;
            }

            .modal-btn {
                flex: 1;
                text-align: center;
                padding: 12px 5px;
            }
        }

        /* 底部按钮区域样式 */
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-default {
            border: 1px solid var(--border-color);
            background-color: white;
            color: var(--secondary-text-color);
        }
        
        .btn-default:hover {
            background-color: #f5f5f5;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 480px) {
            .form-actions {
                justify-content: flex-start;
            }
            
            .btn {
                padding: 12px 20px;
            }
        }
        
        /* 按钮组样式 */
        .buttons-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 5px;
            justify-content: flex-end;
        }
        
        @media (max-width: 768px) {
            .buttons-group {
                margin-top: 15px;
                justify-content: flex-start;
                width: 100%;
                gap: 10px;
            }
            
            .setting-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        /* 缓存清理按钮样式 */
        .cache-btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            min-width: 135px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .cache-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .cache-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .cache-btn-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }
        
        .cache-btn-danger:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }
        
        .cache-btn-secondary {
            background-color: var(--light-background-color);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
        }
        
        .cache-btn-secondary:hover {
            background-color: #e5e7eb;
        }
        
        /* 移动设备优化 */
        @media (max-width: 768px) {
            .cache-btn {
                padding: 12px 16px;
                width: calc(50% - 5px);
            }
            
            .cache-btn svg {
                width: 18px;
                height: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .cache-btn {
                width: 100%;
                margin-bottom: 8px;
                justify-content: flex-start;
                padding: 12px 20px;
            }
        }
    </style>
</head>
<body style="height: 100%; overflow: auto;">
    <!-- 设置页面 -->
    <div id="settings" class="form-container">
        <h2>系统设置</h2>
        <div class="settings-section">
            <h3>账号设置</h3>
            <p>支持添加多个Resend账号，系统会自动轮询使用这些账号发送邮件</p>
            <div id="accounts-container">
                <!-- 账号列表将在JavaScript中动态生成 -->
            </div>
            <button type="button" id="addAccountBtn" class="add-account-btn">添加账号</button>
        </div>
        
        <form id="settingsForm">
            <div class="settings-section">
                <h3>发送设置</h3>
                <div class="form-group">
                    <div class="setting-row">
                        <div class="setting-info">
                            <label for="enableRandomPrefix">启用发件人邮箱前缀随机化</label>
                            <small class="form-text">自动添加随机前缀，有助于提高邮件送达率。</small>
                        </div>
                        <div class="toggle-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enableRandomPrefix">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>系统维护</h3>
                <p>管理系统缓存和数据，优化系统性能</p>
                <div class="form-group">
                    <div class="setting-row">
                        <div class="setting-info">
                            <label>清除系统缓存</label>
                            <small class="form-text">清除浏览器中存储的系统缓存数据，可能有助于解决一些功能异常问题。</small>
                        </div>
                        <div class="buttons-group">
                            <button type="button" id="clearAllCacheBtn" class="cache-btn cache-btn-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                </svg>
                                清除所有缓存
                            </button>
                            <button type="button" id="clearCacheKeepAccountsBtn" class="cache-btn cache-btn-secondary">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                                </svg>
                                保留账号信息
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>系统说明</h3>
                <p>本系统智能调整发送策略：</p>
                <ul class="feature-list">
                    <li>智能调整收件人数量，无需手动设置</li>
                    <li>单账号模式：适用于少量收件人(≤10个)</li>
                    <li>多账号模式：支持大量收件人和高频发送</li>
                </ul>
                <p>发送策略自动选择规则：</p>
                <ul class="feature-list">
                    <li>1个账号 + ≤10个收件人：单账号模式</li>
                    <li>多个账号或>10个收件人：多账号批量模式</li>
                </ul>
                <p class="feature-highlight">智能算法自动管理账号轮换，无需手动配置批量和频率限制</p>
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancelAccountBtn" class="btn btn-default" style="margin-right: 15px;">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>

    <!-- 添加账号对话框（模态框） -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">添加Resend账号</h3>
            <form id="accountForm">
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" placeholder="输入Resend API Key" required>
                    <small class="form-text">可从Resend官网控制台获取: <a href="https://resend.com/api-keys" target="_blank" style="color:var(--primary-color);">https://resend.com/api-keys</a></small>
                </div>
                <div class="form-group">
                    <label for="domain">已验证域名</label>
                    <input type="text" id="domain" placeholder="如: example.com" required>
                    <small class="form-text">已在Resend验证的发件域名，用于构建发件地址</small>
                </div>
                <div class="form-group">
                    <label for="accountName">账号名称（可选）</label>
                    <input type="text" id="accountName" placeholder="如: 主账号">
                    <small class="form-text">用于在账号列表中区分不同账号</small>
                </div>
                <div class="modal-footer">
                    <button type="button" id="cancelModalBtn" class="modal-btn modal-btn-cancel" style="margin-right: 15px;">取消</button>
                    <button type="submit" class="modal-btn modal-btn-save">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 清除缓存确认对话框 -->
    <div id="clearCacheModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">确认清除缓存</h3>
            <p id="clearCacheMessage" style="margin-bottom: 20px; line-height: 1.5;">确定要清除系统缓存吗？此操作不可撤销。</p>
            <div class="modal-footer">
                <button type="button" id="cancelClearCacheBtn" class="modal-btn modal-btn-cancel" style="margin-right: 15px;">取消</button>
                <button type="button" id="confirmClearCacheBtn" class="modal-btn modal-btn-save">确认清除</button>
            </div>
        </div>
    </div>

    <script>
        // 用于存储和管理账号设置
        const AccountManager = {
            // 获取所有账号
            getAccounts() {
                try {
                    const accounts = localStorage.getItem('resendAccounts');
                    return accounts ? JSON.parse(accounts) : [];
                } catch (error) {
                    console.error('获取账号时出错:', error);
                    return [];
                }
            },
            
            // 添加新账号
            addAccount(account) {
                try {
                    const accounts = this.getAccounts();
                    accounts.push(account);
                    localStorage.setItem('resendAccounts', JSON.stringify(accounts));
                    
                    // 如果这是第一个账号，将其设为当前活跃账号
                    if (accounts.length === 1) {
                        localStorage.setItem('activeAccountIndex', '0');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('添加账号时出错:', error);
                    return false;
                }
            },
            
            // 更新账号
            updateAccount(index, account) {
                try {
                    const accounts = this.getAccounts();
                    if (index >= 0 && index < accounts.length) {
                        accounts[index] = account;
                        localStorage.setItem('resendAccounts', JSON.stringify(accounts));
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('更新账号时出错:', error);
                    return false;
                }
            },
            
            // 删除账号
            deleteAccount(index) {
                try {
                    const accounts = this.getAccounts();
                    if (index >= 0 && index < accounts.length) {
                        accounts.splice(index, 1);
                        localStorage.setItem('resendAccounts', JSON.stringify(accounts));
                        
                        // 更新当前活跃账号索引
                        const activeIndex = parseInt(localStorage.getItem('activeAccountIndex') || '0');
                        if (activeIndex >= accounts.length) {
                            localStorage.setItem('activeAccountIndex', accounts.length > 0 ? '0' : '');
                        } else if (activeIndex === index && accounts.length > 0) {
                            // 如果删除的是当前活跃账号，则切换到第一个账号
                            localStorage.setItem('activeAccountIndex', '0');
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('删除账号时出错:', error);
                    return false;
                }
            },
            
            // 设置当前活跃账号
            setActiveAccount(index) {
                try {
                    const accounts = this.getAccounts();
                    if (index >= 0 && index < accounts.length) {
                        localStorage.setItem('activeAccountIndex', index.toString());
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('设置活跃账号时出错:', error);
                    return false;
                }
            },
            
            // 获取当前活跃账号索引
            getActiveAccountIndex() {
                try {
                    const index = parseInt(localStorage.getItem('activeAccountIndex') || '0');
                    const accounts = this.getAccounts();
                    return (index >= 0 && index < accounts.length) ? index : 0;
                } catch (error) {
                    console.error('获取活跃账号索引时出错:', error);
                    return 0;
                }
            }
        };
        
        // 通知父窗口页面已加载完成
        window.onload = function() {
            if (window.parent && window.parent.pageLoaded) {
                window.parent.pageLoaded('settings');
            }
            
            // 初始化账号列表
            renderAccountsList();
            
            // 初始化账号添加对话框
            initAccountModal();
            
            // 初始化设置表单
            initSettingsForm();
            
            // 初始化缓存清理功能
            initCacheClearFunctions();
        };
        
        // 渲染账号列表
        function renderAccountsList() {
            const accountsContainer = document.getElementById('accounts-container');
            const accounts = AccountManager.getAccounts();
            const activeIndex = AccountManager.getActiveAccountIndex();
            
            // 清空容器
            accountsContainer.innerHTML = '';
            
            if (accounts.length === 0) {
                // 没有账号时显示提示信息
                accountsContainer.innerHTML = `
                    <div class="empty-accounts-message">
                        <div class="empty-state-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 01-6.364 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9.75 9.75c0 .414-.168.844-.467 1.143A1.5 1.5 0 018.25 12h7.5M12 15.75a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div class="empty-state-text">
                            尚未添加任何Resend账号，请点击下方"添加账号"按钮添加。
                        </div>
                    </div>
                `;
                return;
            }
            
            // 创建账号卡片
            accounts.forEach((account, index) => {
                const isActive = index === activeIndex;
                const accountName = account.name || `账号 ${index + 1}`;
                const apiKeyPreview = account.apiKey ? `${account.apiKey.substring(0, 5)}...${account.apiKey.substring(account.apiKey.length - 4)}` : '未设置';
                const domain = account.domain || '未设置';
                
                const accountCard = document.createElement('div');
                accountCard.className = 'account-item';
                accountCard.classList.toggle('active', isActive);
                accountCard.innerHTML = `
                    <div class="account-name">${accountName}</div>
                    <div class="account-details">
                        <div class="account-detail-item">
                            <div class="account-detail-label">API Key</div>
                            <div class="account-detail-value monospace">${apiKeyPreview}</div>
                        </div>
                        <div class="account-detail-item">
                            <div class="account-detail-label">发送域名</div>
                            <div class="account-detail-value">${domain}</div>
                        </div>
                    </div>
                    <div class="account-actions">
                        ${!isActive ? `<button type="button" class="set-active-btn account-btn btn-primary" data-index="${index}">设为当前</button>` : ''}
                        <button type="button" class="edit-account-btn account-btn btn-secondary" data-index="${index}">编辑</button>
                        <button type="button" class="delete-account-btn account-btn btn-danger" data-index="${index}">删除</button>
                    </div>
                    ${isActive ? `<div class="active-label">当前使用</div>` : ''}
                `;
                
                accountsContainer.appendChild(accountCard);
            });
            
            // 添加点击事件处理
            document.querySelectorAll('.set-active-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    AccountManager.setActiveAccount(index);
                    renderAccountsList(); // 重新渲染列表
                    
                    // 显示提示消息
                    if (window.parent && window.parent.showNotification) {
                        window.parent.showNotification('已切换当前使用的账号', 'success');
                    }
                });
            });
            
            document.querySelectorAll('.edit-account-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const accounts = AccountManager.getAccounts();
                    const account = accounts[index];
                    
                    // 打开编辑对话框
                    document.getElementById('apiKey').value = account.apiKey || '';
                    document.getElementById('domain').value = account.domain || '';
                    document.getElementById('accountName').value = account.name || '';
                    
                    // 设置当前编辑的账号索引
                    document.getElementById('accountForm').setAttribute('data-edit-index', index.toString());
                    
                    // 更新标题
                    document.querySelector('.modal-title').textContent = '编辑Resend账号';
                    
                    // 显示对话框
                    document.getElementById('accountModal').style.display = 'block';
                    // 禁用页面滚动
                    document.body.style.overflow = 'hidden';
                });
            });
            
            document.querySelectorAll('.delete-account-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (confirm('确定要删除此账号吗？')) {
                        AccountManager.deleteAccount(index);
                        renderAccountsList(); // 重新渲染列表
                        
                        // 显示提示消息
                        if (window.parent && window.parent.showNotification) {
                            window.parent.showNotification('账号已删除', 'success');
                        }
                    }
                });
            });
        }
        
        // 初始化账号对话框
        function initAccountModal() {
            const addAccountBtn = document.getElementById('addAccountBtn');
            const accountModal = document.getElementById('accountModal');
            const accountForm = document.getElementById('accountForm');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            
            // 点击"添加账号"按钮打开对话框
            addAccountBtn.addEventListener('click', function() {
                // 清空表单
                accountForm.reset();
                // 移除编辑索引
                accountForm.removeAttribute('data-edit-index');
                // 更新标题为添加模式
                document.querySelector('.modal-title').textContent = '添加Resend账号';
                // 显示对话框
                accountModal.style.display = 'block';
                // 禁用页面滚动
                document.body.style.overflow = 'hidden';
            });
            
            // 点击"取消"按钮关闭对话框
            cancelModalBtn.addEventListener('click', function() {
                accountModal.style.display = 'none';
                // 恢复页面滚动
                document.body.style.overflow = 'auto';
            });
            
            // 点击对话框外部关闭对话框
            accountModal.addEventListener('click', function(e) {
                if (e.target === accountModal) {
                    accountModal.style.display = 'none';
                    // 恢复页面滚动
                    document.body.style.overflow = 'auto';
                }
            });
            
            // 提交表单处理
            accountForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单值
                const apiKey = document.getElementById('apiKey').value.trim();
                const domain = document.getElementById('domain').value.trim();
                const name = document.getElementById('accountName').value.trim();
                
                // 验证API Key
                if (!apiKey) {
                    alert('请输入API Key');
                    return;
                }
                
                // 验证域名
                if (!domain) {
                    alert('请输入已验证域名');
                    return;
                }
                
                // 验证域名格式
                const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/;
                if (!domainRegex.test(domain)) {
                    alert('请输入有效的域名格式，例如：example.com');
                    return;
                }
                
                // 创建账号对象
                const account = {
                    apiKey,
                    domain,
                    name
                };
                
                // 检查是编辑还是添加
                const editIndex = accountForm.getAttribute('data-edit-index');
                if (editIndex !== null && editIndex !== undefined) {
                    // 更新现有账号
                    const index = parseInt(editIndex);
                    AccountManager.updateAccount(index, account);
                    
                    // 显示提示消息
                    if (window.parent && window.parent.showNotification) {
                        window.parent.showNotification('账号已更新', 'success');
                    }
                } else {
                    // 添加新账号
                    AccountManager.addAccount(account);
                    
                    // 显示提示消息
                    if (window.parent && window.parent.showNotification) {
                        window.parent.showNotification('新账号已添加', 'success');
                    }
                }
                
                // 关闭对话框并重新渲染账号列表
                accountModal.style.display = 'none';
                renderAccountsList();
            });
        }
        
        // 初始化设置表单
        function initSettingsForm() {
            const settingsForm = document.getElementById('settingsForm');
            const enableRandomPrefixInput = document.getElementById('enableRandomPrefix');
            const cancelSettingsBtn = document.getElementById('cancelAccountBtn');
            
            // 添加取消按钮事件处理
            cancelSettingsBtn.addEventListener('click', function() {
                // 如果在父窗口中，返回到首页
                if (window.parent && window.parent.navigateTo) {
                    window.parent.navigateTo('home');
                }
            });
            
            // 加载现有设置
            try {
                const settings = JSON.parse(localStorage.getItem('emailSettings') || '{}');
                
                // 设置随机前缀复选框状态
                if (settings.enableRandomPrefix !== undefined) {
                    enableRandomPrefixInput.checked = settings.enableRandomPrefix;
                }
            } catch (error) {
                console.error('加载设置时出错:', error);
            }
            
            // 提交表单处理
            settingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取表单值
                const enableRandomPrefix = enableRandomPrefixInput.checked;
                
                // 保存设置
                const settings = {
                    enableRandomPrefix
                };
                
                localStorage.setItem('emailSettings', JSON.stringify(settings));
                
                // 显示提示消息
                if (window.parent && window.parent.showNotification) {
                    window.parent.showNotification('设置已保存', 'success');
                } else {
                    alert('设置已保存');
                }
            });
        }
        
        // 监听窗口大小变化，调整UI
        window.addEventListener('resize', function() {
            // 这里可以添加动态UI调整逻辑
        });

        // 初始化开关状态显示
        document.addEventListener('DOMContentLoaded', function() {
            const toggleSwitches = document.querySelectorAll('.toggle-switch input[type="checkbox"]');
            toggleSwitches.forEach(function(toggle) {
                // 添加变化事件以更新状态显示
                toggle.addEventListener('change', function() {
                    // 状态文本会通过CSS自动更新
                });
            });
        });
        
        // 初始化缓存清理功能
        function initCacheClearFunctions() {
            const clearAllCacheBtn = document.getElementById('clearAllCacheBtn');
            const clearCacheKeepAccountsBtn = document.getElementById('clearCacheKeepAccountsBtn');
            const clearCacheModal = document.getElementById('clearCacheModal');
            const clearCacheMessage = document.getElementById('clearCacheMessage');
            const cancelClearCacheBtn = document.getElementById('cancelClearCacheBtn');
            const confirmClearCacheBtn = document.getElementById('confirmClearCacheBtn');
            
            let clearMode = ''; // 'all' 或 'keepAccounts'
            
            // 点击"清除所有缓存"按钮
            clearAllCacheBtn.addEventListener('click', function() {
                clearMode = 'all';
                clearCacheMessage.textContent = '确定要清除所有系统缓存吗？此操作将清除所有数据，包括已保存的账号信息！此操作不可撤销。';
                clearCacheModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
            
            // 点击"保留账号信息"按钮
            clearCacheKeepAccountsBtn.addEventListener('click', function() {
                clearMode = 'keepAccounts';
                clearCacheMessage.textContent = '确定要清除系统缓存（保留账号信息）吗？此操作将清除除账号信息外的所有设置数据。此操作不可撤销。';
                clearCacheModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
            
            // 点击"取消"按钮关闭对话框
            cancelClearCacheBtn.addEventListener('click', function() {
                clearCacheModal.style.display = 'none';
                document.body.style.overflow = 'auto';
            });
            
            // 点击对话框外部关闭对话框
            clearCacheModal.addEventListener('click', function(e) {
                if (e.target === clearCacheModal) {
                    clearCacheModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
            
            // 点击"确认清除"按钮
            confirmClearCacheBtn.addEventListener('click', function() {
                if (clearMode === 'all') {
                    // 清除所有缓存
                    clearAllCache();
                } else if (clearMode === 'keepAccounts') {
                    // 清除缓存但保留账号信息
                    clearCacheKeepAccounts();
                }
                
                // 关闭对话框
                clearCacheModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // 显示成功提示
                if (window.parent && window.parent.showNotification) {
                    window.parent.showNotification('缓存已成功清除', 'success');
                } else {
                    alert('缓存已成功清除');
                }
            });
        }
        
        // 清除所有缓存
        function clearAllCache() {
            try {
                // 保存当前打开的页面标记
                const currentPage = 'settings';
                
                // 清除localStorage中的所有数据
                localStorage.clear();
                
                // 重置页面状态
                renderAccountsList();
                document.getElementById('enableRandomPrefix').checked = false;
                
                // 提示用户刷新页面以完成清除
                setTimeout(function() {
                    if (confirm('缓存已清除，建议刷新页面以应用更改。是否立即刷新？')) {
                        if (window.parent && window.parent.navigateTo) {
                            window.parent.navigateTo(currentPage);
                        } else {
                            window.location.reload();
                        }
                    }
                }, 500);
                
                return true;
            } catch (error) {
                console.error('清除缓存时出错:', error);
                return false;
            }
        }
        
        // 清除缓存但保留账号信息
        function clearCacheKeepAccounts() {
            try {
                // 保存账号相关信息
                const resendAccounts = localStorage.getItem('resendAccounts');
                const activeAccountIndex = localStorage.getItem('activeAccountIndex');
                
                // 清除localStorage中的所有数据
                localStorage.clear();
                
                // 恢复账号相关信息
                if (resendAccounts) {
                    localStorage.setItem('resendAccounts', resendAccounts);
                }
                if (activeAccountIndex) {
                    localStorage.setItem('activeAccountIndex', activeAccountIndex);
                }
                
                // 重置页面状态
                renderAccountsList();
                document.getElementById('enableRandomPrefix').checked = false;
                
                return true;
            } catch (error) {
                console.error('清除缓存时出错:', error);
                return false;
            }
        }
    </script>
</body>
</html> 